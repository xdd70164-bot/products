<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1 æœˆæ´»å‹•çå‹µï½œå…Œæ›å°ˆå€</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f6f6f6;color:#222;}
header{text-align:center;padding:40px 20px 24px;}
header h1{margin:0;font-size:28px;letter-spacing:2px;}
header p{margin-top:12px;color:#666;font-size:14px;line-height:1.6;}
.grid{
  max-width:1200px;margin:30px auto 60px;padding:0 16px;
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:22px;
}
.card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.06);cursor:pointer;position:relative;}
.card.disabled{opacity:.4;pointer-events:none;}
.card img{width:100%;height:180px;object-fit:contain;background:#fafafa;}
.info{padding:14px;text-align:center;}
.name{font-weight:600;font-size:15px;margin-bottom:6px;}
.stock{font-size:13px;color:#555;}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;z-index:999;}
.overlay img{max-width:90%;max-height:90%;border-radius:10px;}
</style>
</head>

<body>

<header>
  <h1>1 æœˆæ´»å‹•çå‹µï½œå…Œæ›å°ˆå€</h1>
  <p>è«‹é»é¸ä½ è¦å…Œæ›çš„çå“ï¼ˆæ¯äººé™ä¸€æ¬¡ï¼‰</p>
</header>

<div class="grid">

<!-- â¬‡ï¸ æ¯å€‹å¡ç‰‡åªéœ€è¦æŒ‡å®š data-id -->
<div class="card" data-id="kettle">
  <img src="images/electrolux-kettle.jpg" onclick="zoom(event,this)">
  <div class="info">
    <div class="name">-</div>
    <div class="stock">è®€å–ä¸­â€¦</div>
  </div>
</div>

<div class="card" data-id="samsonite">
  <img src="images/samsonite-mini-case.jpg" onclick="zoom(event,this)">
  <div class="info">
    <div class="name">-</div>
    <div class="stock">è®€å–ä¸­â€¦</div>
  </div>
</div>

<div class="card" data-id="worldwide">
  <img src="images/worldwide-cabin-case.jpg" onclick="zoom(event,this)">
  <div class="info">
    <div class="name">-</div>
    <div class="stock">è®€å–ä¸­â€¦</div>
  </div>
</div>

</div>

<footer style="text-align:center;font-size:12px;color:#999;padding-bottom:30px;">
Â© åœ–ç‰‡åƒ…ä¾›ç¤ºæ„ï¼Œå¯¦éš›å…Œæ›å“é …ä»¥ç¾å ´å…¬å‘Šç‚ºæº–
</footer>

<div class="overlay" onclick="this.style.display='none'">
  <img id="zoomImg">
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBEmxW-TqnxW3pgoXc2pfatFtqSQQkqMsE",
  databaseURL: "https://january-reward-default-rtdb.asia-southeast1.firebasedatabase.app"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== ä½¿ç”¨è€…é©—è­‰ ===== */
const me = JSON.parse(sessionStorage.getItem("me"));
if(!me) location.href="index.html";

if(localStorage.getItem("picked_"+me.no)==="true"){
  location.href="wait.html";
}

/* ===== å¡ç‰‡é‚è¼¯ ===== */
document.querySelectorAll(".card").forEach(card=>{
  const itemId = card.dataset.id;
  const nameEl = card.querySelector(".name");
  const stockEl = card.querySelector(".stock");
  const itemRef = db.ref("items/"+itemId);

  // ğŸ”„ å³æ™‚åŒæ­¥åº«å­˜
  itemRef.on("value", snap=>{
    if(!snap.exists()) return;
    const { name, stock } = snap.val();
    nameEl.innerText = name;
    stockEl.innerText = "å‰©é¤˜æ•¸é‡ï¼š" + stock;
    if(stock<=0) card.classList.add("disabled");
  });

  card.addEventListener("click", ()=>{
    if(card.classList.contains("disabled")) return;
    if(!confirm(`ç¢ºå®šè¦å…Œæ›ã€Œ${nameEl.innerText}ã€å—ï¼Ÿ`)) return;

    const pickedRef = db.ref("picked/"+me.no);

    pickedRef.once("value").then(p=>{
      if(p.exists()){
        alert("ä½ å·²å…Œæ›éçå“");
        location.href="wait.html";
        return;
      }

      // ğŸ” åŸå­æ‰£åº«å­˜
      itemRef.child("stock").transaction(cur=>{
        if(cur>0) return cur-1;
      }, (err, committed)=>{
        if(err || !committed){
          alert("åº«å­˜ä¸è¶³ï¼Œè«‹é‡æ–°é¸æ“‡");
          return;
        }

        pickedRef.set(true);
        localStorage.setItem("picked_"+me.no,"true");

        db.ref("pickLog").push({
          no: me.no,
          name: me.name,
          rank: me.rank,
          item: nameEl.innerText,
          time: new Date().toISOString()
        });

        alert(`å…Œæ›æˆåŠŸï¼š${nameEl.innerText}`);
        location.href="wait.html";
      });
    });
  });
});

function zoom(e,img){
  e.stopPropagation();
  document.getElementById("zoomImg").src = img.src;
  document.querySelector(".overlay").style.display="flex";
}
</script>

</body>
</html>
