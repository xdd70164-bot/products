<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ´»å‹•ç®¡ç†å¾Œå°ï½œåŒ¯å‡º Excel / é‡ç½®</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f6f6f6;padding:40px;text-align:center;}
.box{background:#fff;display:inline-block;padding:30px 32px;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);min-width:340px;}
h2{margin-top:0;}
button{font-size:18px;padding:12px 20px;margin:8px;border:0;border-radius:12px;cursor:pointer;}
.download{background:#6c5ce7;color:#fff;}
.reset{background:#f39c12;color:#fff;}
.danger{background:#e74c3c;color:#fff;}
small{display:block;color:#666;margin-top:10px;line-height:1.6;}
.badge{display:inline-block;background:#f1f2f6;color:#2d3436;padding:6px 10px;border-radius:999px;font-size:13px;margin-top:10px;}
.turn{font-size:42px;font-weight:800;margin:18px 0;}
.prev{background:#3498db;color:#fff;}
.next{background:#2ecc71;color:#fff;}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ› æ´»å‹•ç®¡ç†å¾Œå°</h2>
  <div class="badge" id="actName">æ´»å‹•ï¼š-</div>

  <div style="margin-top:14px;">ç›®å‰è¼ªåˆ°</div>
  <div class="turn" id="turn">-</div>

  <button class="prev" onclick="prev()">â¬… ä¸Šä¸€ä½</button>
  <button class="next" onclick="next()">â¡ ä¸‹ä¸€ä½</button><br>

  <button class="reset" onclick="resetTurn()">ğŸ”„ é‡ç½®é †ä½</button><br>

  <button class="download" onclick="downloadExcelOnly()">ğŸ“¥ ä¸€éµåŒ¯å‡º Excelï¼ˆä¸é‡ç½®ï¼‰</button><br>

  <button class="danger" onclick="exportThenReset()">âš  åŒ¯å‡ºå¾Œé‡ç½®ï¼ˆå»ºè­°æ”¶å·¥ç”¨ï¼‰</button>

  <small>
    ğŸ“¥ åŒ¯å‡º Excelï¼šåªä¸‹è¼‰ï¼Œä¸æ¸…è³‡æ–™<br>
    âš  åŒ¯å‡ºå¾Œé‡ç½®ï¼šæœƒå…ˆåŒ¯å‡ºï¼Œå†æ¸…ç©º pickLog/pickedã€é‡è¨­åº«å­˜ã€currentTurn=1
  </small>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJSï¼ˆExcelï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/* ===================== å¯è‡ªè¨‚ï¼šæ´»å‹•åç¨± ===================== */
const ACTIVITY_NAME = "2026 1 æœˆæ´»å‹•çå‹µ";
document.getElementById("actName").innerText = "æ´»å‹•ï¼š" + ACTIVITY_NAME;

/* ===================== Firebase è¨­å®š ===================== */
firebase.initializeApp({
  apiKey: "AIzaSyBEmxW-TqnxW3pgoXc2pfatFtqSQQkqMsE",
  databaseURL: "https://january-reward-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ===================== ç›®å‰é †ä½é¡¯ç¤ºèˆ‡æ§åˆ¶ ===================== */
const turnRef = db.ref("currentTurn");
turnRef.on("value", snap=>{
  document.getElementById("turn").innerText = snap.val() ?? "-";
});
function next(){ turnRef.transaction(v => (v || 1) + 1); }
function prev(){ turnRef.transaction(v => Math.max(1, (v || 1) - 1)); }
function resetTurn(){ if(confirm("ç¢ºå®šæŠŠé †ä½é‡ç½®ç‚ºç¬¬ 1 åï¼Ÿ")) turnRef.set(1); }

/* ===================== å·¥å…·ï¼šæ ¼å¼åŒ–æ™‚é–“ï¼ˆçµ¦ Excel å¥½è®€ï¼‰ ===================== */
function toLocalTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d.getTime())) return iso;
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* ===================== âœ… ä¸€éµåŒ¯å‡º Excelï¼ˆæ ¸å¿ƒï¼‰ ===================== */
async function exportPickLogToExcel(){
  // 1) è®€å– pickLog
  const snap = await db.ref("pickLog").once("value");
  const data = snap.val();
  if(!data){
    alert("ç›®å‰æ²’æœ‰ä»»ä½•é¸çç´€éŒ„å¯åŒ¯å‡º");
    return false;
  }

  const entries = Object.entries(data).map(([key, r]) => ({ _key: key, ...r }));

  // 2) åµæ¸¬åŒä¸€ no æ˜¯å¦é‡è¤‡å‡ºç¾ï¼ˆç•°å¸¸æ¨™è¨˜ï¼‰
  const countByNo = {};
  entries.forEach(r=>{
    const no = Number(r.no ?? 0);
    countByNo[no] = (countByNo[no] || 0) + 1;
  });

  // 3) çµ„ Excel rowsï¼ˆæ¬„ä½å›ºå®šã€å¥½è®€ï¼‰
  const rows = entries.map(r=>{
    const no = Number(r.no ?? 0);
    const rank = Number(r.rank ?? 0);
    const name = r.name ?? "";
    const item = r.item ?? "";
    const iso = r.time ?? "";
    const local = toLocalTime(iso);
    const dup = (countByNo[no] > 1) ? "é‡è¤‡é¸/è·¨è£ç½®" : "";

    return {
      æ´»å‹•åç¨±: ACTIVITY_NAME,
      æ’å: rank || "",
      ç·¨è™Ÿ: no || "",
      å§“å: name,
      çå“: item,
      æ™‚é–“_ISO: iso,
      æ™‚é–“_æœ¬åœ°: local,
      ç•°å¸¸: dup
    };
  });

  // 4) æ’åºï¼šå…ˆæ’åï¼Œå†æ™‚é–“
  rows.sort((a,b)=>{
    const ra = (a.æ’å === "" ? 999999 : a.æ’å);
    const rb = (b.æ’å === "" ? 999999 : b.æ’å);
    if(ra !== rb) return ra - rb;
    return String(a.æ™‚é–“_ISO).localeCompare(String(b.æ™‚é–“_ISO));
  });

  // 5) ç”¢ç”Ÿ Excelï¼ˆå«æ¬„å¯¬ï¼‰
  const ws = XLSX.utils.json_to_sheet(rows);

  // æ¬„å¯¬å„ªåŒ–ï¼ˆå¯è®€æ€§ï¼‰
  ws["!cols"] = [
    { wch: 18 }, // æ´»å‹•åç¨±
    { wch: 6 },  // æ’å
    { wch: 6 },  // ç·¨è™Ÿ
    { wch: 10 }, // å§“å
    { wch: 28 }, // çå“
    { wch: 24 }, // ISO
    { wch: 20 }, // æœ¬åœ°
    { wch: 14 }  // ç•°å¸¸
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "èª°é¸ä»€éº¼");

  // 6) æª”åï¼šé¿å…è¦†è“‹
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  const filename =
    `èª°é¸ä»€éº¼_${ACTIVITY_NAME}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.xlsx`
    .replace(/[\\/:*?"<>|]/g, "_");

  XLSX.writeFile(wb, filename);
  return true;
}

/* ===================== ğŸ“¥ åªåŒ¯å‡ºï¼Œä¸é‡ç½® ===================== */
async function downloadExcelOnly(){
  await exportPickLogToExcel();
}

/* ===================== âš  åŒ¯å‡ºå¾Œé‡ç½® ===================== */
/* éœ€è¦ä½  Firebase æœ‰ initialStockï¼ˆåˆå§‹åº«å­˜è¡¨ï¼‰ï¼š
   initialStock/{itemId}: number
*/
async function exportThenReset(){
  const ok = confirm(
    "âš  è­¦å‘Šï¼šæ­¤å‹•ä½œæœƒï¼š\n\n" +
    "1ï¸âƒ£ åŒ¯å‡º Excelï¼ˆèª°é¸ä»€éº¼ï¼‰\n" +
    "2ï¸âƒ£ æ¸…ç©º pickLogã€picked\n" +
    "3ï¸âƒ£ åº«å­˜å›åˆ° initialStock\n" +
    "4ï¸âƒ£ currentTurn=1\n\n" +
    "ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ"
  );
  if(!ok) return;

  // å…ˆåŒ¯å‡º
  const exported = await exportPickLogToExcel();
  if(!exported) return; // æ²’è³‡æ–™å°±ä¸é‡ç½®ï¼Œé¿å…èª¤æ¸…

  // è®€ initialStock
  const stockSnap = await db.ref("initialStock").once("value");
  if(!stockSnap.exists()){
    alert("æ‰¾ä¸åˆ° initialStockï¼Œå·²åŒ¯å‡ºä½†æœªé‡ç½®ã€‚\nè«‹å…ˆåœ¨ Firebase å»º initialStock å†ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚");
    return;
  }
  const initial = stockSnap.val();

  // çµ„ updateï¼ˆä¸€æ¬¡åŸå­æ›´æ–°ï¼‰
  const updates = {};
  Object.keys(initial).forEach(id=>{
    updates[`items/${id}/stock`] = initial[id];
  });
  updates["picked"] = null;
  updates["pickLog"] = null;
  updates["currentTurn"] = 1;

  await db.ref().update(updates);
  alert("âœ… å·²åŒ¯å‡ºä¸¦å®Œæˆé‡ç½®");
}
</script>

</body>
</html>
