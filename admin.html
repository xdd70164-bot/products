<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1 æœˆæ´»å‹•çå‹µï½œä¸»æŒäººæ§åˆ¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f6f6f6;
  padding:40px;
  text-align:center;
}
.box{
  background:#fff;
  display:inline-block;
  padding:30px 32px;
  border-radius:18px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  min-width:340px;
}
h2{margin-top:0;}
.turn{
  font-size:42px;
  font-weight:800;
  margin:20px 0;
}
button{
  font-size:18px;
  padding:12px 20px;
  margin:8px;
  border:0;
  border-radius:12px;
  cursor:pointer;
}
.next{background:#2ecc71;color:#fff;}
.prev{background:#3498db;color:#fff;}
.reset{background:#f39c12;color:#fff;}
.download{background:#6c5ce7;color:#fff;}
.danger{background:#e74c3c;color:#fff;}
small{
  display:block;
  color:#888;
  margin-top:10px;
  line-height:1.5;
}
.badge{
  display:inline-block;
  background:#f1f2f6;
  color:#2d3436;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ¤ ä¸»æŒäººæ§åˆ¶å°</h2>

  <div class="badge" id="actName">æ´»å‹•ï¼š-</div>

  <div style="margin-top:14px;">ç›®å‰è¼ªåˆ°</div>
  <div class="turn" id="turn">-</div>

  <button class="prev" onclick="prev()">â¬… ä¸Šä¸€ä½</button>
  <button class="next" onclick="next()">â¡ ä¸‹ä¸€ä½</button><br>

  <button class="reset" onclick="resetTurn()">ğŸ”„ é‡ç½®é †ä½</button><br>

  <button class="download" onclick="downloadExcelOnly()">ğŸ“¥ ä¸‹è¼‰ Excelï¼ˆä¸é‡è£½ï¼‰</button><br>

  <button class="danger" onclick="fullReset()">âš  ä¸€éµé‡è£½ï¼ˆå…ˆä¸‹è¼‰å†æ¸…ç©ºï¼‰</button>

  <small>
    ğŸ“¥ ä¸‹è¼‰ Excelï¼šåªåŒ¯å‡ºã€Œèª°é¸ä»€éº¼ã€ä¸æ¸…è³‡æ–™<br>
    âš  ä¸€éµé‡è£½ï¼šæœƒå…ˆä¸‹è¼‰ Excelï¼Œå†æ¸…ç©º pickLogã€ä¸¦æŠŠ currentTurn=1
  </small>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJSï¼ˆExcel ç”¢ç”Ÿå™¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/* ===================== å¯è‡ªè¨‚ï¼šæ´»å‹•åç¨± ===================== */
const ACTIVITY_NAME = "2026 1 æœˆæ´»å‹•çå‹µ"; // â† ä½ è¦æ”¹æ´»å‹•åç¨±å°±æ”¹é€™ä¸€è¡Œ
document.getElementById("actName").innerText = "æ´»å‹•ï¼š" + ACTIVITY_NAME;

/* ===================== Firebase è¨­å®š ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyBEmxW-TqnxW3pgoXc2pfatFtqSQQkqMsE",
  authDomain: "january-reward.firebaseapp.com",
  databaseURL: "https://january-reward-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "january-reward",
  storageBucket: "january-reward.appspot.com",
  messagingSenderId: "881794098293",
  appId: "1:881794098293:web:453715a4382bd6651d843c"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== ç›®å‰é †ä½é¡¯ç¤º ===================== */
const turnRef = db.ref("currentTurn");
turnRef.on("value", snap=>{
  document.getElementById("turn").innerText = snap.val() ?? "-";
});

/* ===================== æ’åºæ§åˆ¶ ===================== */
function next(){ turnRef.transaction(v => (v || 1) + 1); }
function prev(){ turnRef.transaction(v => Math.max(1, (v || 1) - 1)); }
function resetTurn(){
  if(confirm("ç¢ºå®šè¦æŠŠé †ä½é‡ç½®ç‚ºç¬¬ 1 åï¼Ÿ")) turnRef.set(1);
}

/* ===================== å…±ç”¨ï¼šæ‹‰ pickLog â†’ ç”¢å‡º Excel ===================== */
async function exportPickLogToExcel(){
  const snap = await db.ref("pickLog").once("value");
  const data = snap.val();

  if(!data){
    alert("ç›®å‰æ²’æœ‰ä»»ä½•é¸çç´€éŒ„å¯ä¸‹è¼‰");
    return false;
  }

  const entries = Object.values(data);

  // çµ±è¨ˆåŒä¸€å€‹ no æ˜¯å¦å‡ºç¾å¤šæ¬¡ï¼ˆè·¨æ‰‹æ©Ÿ/åˆ·æ–°ç­‰ç•°å¸¸ï¼‰
  const countByNo = {};
  entries.forEach(r=>{
    const no = Number(r.no ?? 0);
    countByNo[no] = (countByNo[no] || 0) + 1;
  });

  // çµ„åˆ—ï¼šåŠ ä¸Šã€Œæ´»å‹•åç¨±ã€ã€Œæ˜¯å¦é‡è¤‡é¸/ç•°å¸¸ã€
  const rows = entries.map(r=>{
    const no = Number(r.no ?? 0);
    const rank = Number(r.rank ?? 0);
    const name = r.name ?? "";
    const item = r.item ?? "";
    const time = r.time ?? "";
    const dup = (countByNo[no] > 1) ? "é‡è¤‡é¸" : "";

    return {
      æ´»å‹•åç¨±: ACTIVITY_NAME,
      æ’å: rank,
      ç·¨è™Ÿ: no,
      å§“å: name,
      çå“: item,
      æ™‚é–“: time,
      ç•°å¸¸: dup
    };
  }).sort((a,b)=> (a.æ’å - b.æ’å) || (a.æ™‚é–“ > b.æ™‚é–“ ? 1 : -1));

  // ç”¢ Excel
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "èª°é¸ä»€éº¼");

  // æª”åï¼šå«æ—¥æœŸæ™‚é–“ï¼ˆé¿å…è¦†è“‹ï¼‰
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  const filename =
    `èª°é¸ä»€éº¼_${ACTIVITY_NAME}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.xlsx`
      .replace(/[\\/:*?"<>|]/g, "_"); // windows æª”åå®‰å…¨

  XLSX.writeFile(wb, filename);
  return true;
}

/* ===================== ğŸ“¥ åªä¸‹è¼‰ï¼Œä¸é‡è£½ ===================== */
async function downloadExcelOnly(){
  await exportPickLogToExcel();
}

/* ===================== âš  ä¸€éµé‡è£½ï¼šå…ˆä¸‹è¼‰ï¼Œå†æ¸…ç©ºï¼Œå†é‡è¨­é †ä½ ===================== */
async function fullReset(){
  const ok = confirm(
    "âš  è­¦å‘Šï¼šæ­¤å‹•ä½œæœƒï¼š\n\n" +
    "1ï¸âƒ£ ä¸‹è¼‰æ‰€æœ‰é¸çç´€éŒ„ Excelï¼ˆå«æ´»å‹•åç¨±/ç•°å¸¸ï¼‰\n" +
    "2ï¸âƒ£ æ¸…ç©ºæ‰€æœ‰é¸çè³‡æ–™ pickLog\n" +
    "3ï¸âƒ£ é †ä½é‡è¨­ç‚ºç¬¬ 1 å\n\n" +
    "ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ"
  );
  if(!ok) return;

  const exported = await exportPickLogToExcel();
  if(!exported) return; // æ²’è³‡æ–™å°±ä¸æ¸…

  await db.ref("pickLog").remove();
  await turnRef.set(1);

  alert("âœ… å·²å®Œæˆå‚™ä»½ä¸¦é‡è£½\nè«‹æ‰€æœ‰äººé‡æ–°æƒæ QR Code");
}
</script>

</body>
</html>
