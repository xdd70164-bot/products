<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1 æœˆæ´»å‹•çå‹µï½œä¸»æŒäººæ§åˆ¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f6f6f6;
  padding:40px;
  text-align:center;
}
.box{
  background:#fff;
  display:inline-block;
  padding:30px 32px;
  border-radius:18px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  min-width:340px;
}
h2{margin-top:0;}
.turn{
  font-size:42px;
  font-weight:800;
  margin:20px 0;
}
button{
  font-size:18px;
  padding:12px 20px;
  margin:8px;
  border:0;
  border-radius:12px;
  cursor:pointer;
}
.next{background:#2ecc71;color:#fff;}
.prev{background:#3498db;color:#fff;}
.reset{background:#f39c12;color:#fff;}
.download{background:#6c5ce7;color:#fff;}
.danger{background:#e74c3c;color:#fff;}
small{
  display:block;
  color:#888;
  margin-top:10px;
  line-height:1.5;
}
.badge{
  display:inline-block;
  background:#f1f2f6;
  color:#2d3436;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ¤ ä¸»æŒäººæ§åˆ¶å°</h2>

  <div class="badge" id="actName">æ´»å‹•ï¼š-</div>

  <div style="margin-top:14px;">ç›®å‰è¼ªåˆ°</div>
  <div class="turn" id="turn">-</div>

  <button class="prev" onclick="prev()">â¬… ä¸Šä¸€ä½</button>
  <button class="next" onclick="next()">â¡ ä¸‹ä¸€ä½</button><br>

  <button class="reset" onclick="resetTurn()">ğŸ”„ é‡ç½®é †ä½</button><br>

  <button class="download" onclick="downloadExcelOnly()">ğŸ“¥ ä¸‹è¼‰ Excelï¼ˆä¸é‡è£½ï¼‰</button><br>

  <button class="danger" onclick="fullReset()">âš  ä¸€éµé‡è£½ï¼ˆå…ˆä¸‹è¼‰å†æ¸…ç©ºï¼‰</button>

  <small>
    ğŸ“¥ ä¸‹è¼‰ Excelï¼šåªåŒ¯å‡ºã€Œèª°é¸ä»€éº¼ã€ä¸æ¸…è³‡æ–™<br>
    âš  ä¸€éµé‡è£½ï¼šæœƒå…ˆä¸‹è¼‰ Excelï¼Œå†æ¸…ç©º pickLogã€ä¸¦æŠŠ currentTurn=1
  </small>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/* ===================== æ´»å‹•åç¨± ===================== */
const ACTIVITY_NAME = "2026 1 æœˆæ´»å‹•çå‹µ";
document.getElementById("actName").innerText = "æ´»å‹•ï¼š" + ACTIVITY_NAME;

/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyBEmxW-TqnxW3pgoXc2pfatFtqSQQkqMsE",
  authDomain: "january-reward.firebaseapp.com",
  databaseURL: "https://january-reward-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "january-reward",
  storageBucket: "january-reward.appspot.com",
  messagingSenderId: "881794098293",
  appId: "1:881794098293:web:453715a4382bd6651d843c"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== é †ä½ ===================== */
const turnRef = db.ref("currentTurn");
turnRef.on("value", snap=>{
  document.getElementById("turn").innerText = snap.val() ?? "-";
});
function next(){ turnRef.transaction(v => (v || 1) + 1); }
function prev(){ turnRef.transaction(v => Math.max(1, (v || 1) - 1)); }
function resetTurn(){
  if(confirm("ç¢ºå®šè¦æŠŠé †ä½é‡ç½®ç‚ºç¬¬ 1 åï¼Ÿ")) turnRef.set(1);
}

/* ===================== Excel åŒ¯å‡ºï¼ˆç©©å®šç‰ˆï¼‰ ===================== */
function downloadExcelOnly(){
  db.ref("pickLog").once("value").then(snap=>{
    const data = snap.val();
    if(!data){
      alert("ç›®å‰æ²’æœ‰ä»»ä½•é¸çç´€éŒ„");
      return;
    }

    const rows = [];
    const countByNo = {};

    for(const k in data){
      const r = data[k];
      const no = Number(r.no ?? 0);
      countByNo[no] = (countByNo[no] || 0) + 1;

      rows.push({
        æ´»å‹•åç¨±: ACTIVITY_NAME,
        æ’å: Number(r.rank ?? 0),
        ç·¨è™Ÿ: no,
        å§“å: r.name ?? "",
        çå“: r.item ?? "",
        æ™‚é–“: r.time ?? "",
        ç•°å¸¸: ""
      });
    }

    rows.forEach(r=>{
      if(countByNo[r.ç·¨è™Ÿ] > 1) r.ç•°å¸¸ = "é‡è¤‡é¸";
    });

    rows.sort((a,b)=>{
      if(a.æ’å !== b.æ’å) return a.æ’å - b.æ’å;
      return a.æ™‚é–“ > b.æ™‚é–“ ? 1 : -1;
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "èª°é¸ä»€éº¼");

    const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'});
    const blob = new Blob([wbout],{type:"application/octet-stream"});

    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    const filename =
      `èª°é¸ä»€éº¼_${ACTIVITY_NAME}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.xlsx`
      .replace(/[\\/:*?"<>|]/g,"_");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  });
}

/* ===================== ä¸€éµé‡è£½ ===================== */
async function fullReset(){
  const ok = confirm(
    "âš  æ­¤å‹•ä½œæœƒï¼š\n\n" +
    "1ï¸âƒ£ ä¸‹è¼‰ Excel å‚™ä»½\n" +
    "2ï¸âƒ£ æ¸…ç©ºæ‰€æœ‰é¸çè³‡æ–™\n" +
    "3ï¸âƒ£ é †ä½é‡è¨­ç‚ºç¬¬ 1 å\n\n" +
    "ç¢ºå®šåŸ·è¡Œï¼Ÿ"
  );
  if(!ok) return;

  const snap = await db.ref("pickLog").once("value");
  if(!snap.exists()){
    alert("æ²’æœ‰è³‡æ–™å¯é‡è£½");
    return;
  }

  downloadExcelOnly();
  await db.ref("pickLog").remove();
  await turnRef.set(1);

  alert("âœ… å·²å®Œæˆå‚™ä»½ä¸¦é‡è£½");
}
</script>

</body>
</html>

